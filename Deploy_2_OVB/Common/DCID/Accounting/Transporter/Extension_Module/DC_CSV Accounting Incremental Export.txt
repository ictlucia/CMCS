#
# Front Arena exported extension module.
# source          ""
# timestamp (utc) "2022-07-07 20:09:36"
# ***** DO NOT EDIT! *****
#
name        "DC_CSV Accounting Incremental Export"
description "$Id$"

groups {
}

decls[FPythonCode] {
}

clx FObject [FPythonCode] {
  CSV Accounting Incremental Export
import acm
import CSVUploadExport
import FRunScriptGUI
from Transporters import FStoredASQLQueryTransporter
from TaskRunner import RunTaskModuleWithDict
import os



def ExportCSV(objects, folder, filename, layout='vertical'):
    path = os.path.join(folder, filename)
    
    ok = CSVUploadExport.ExportCSV(path, objects, layout, 'utf-8')
    
    if ok:
        print ('created:', path)


def TransporterName(obj):
    if obj.User() is None:
        return obj.Name()
    else:
        return obj.Name() + '@' + obj.User().Name()


def ExportQueryFolders(queryFolders, folder):
    nameParam = ','.join([TransporterName(qf) for qf in queryFolders])
    params    = {'Query Folder': nameParam, 'basepath': folder}

    RunTaskModuleWithDict('TransporterExport', params)



def ExportAccountingPackage(folder, updateTime):
	
    csvFolder         = os.path.join(folder, 'CSV')
    transporterFolder = os.path.join(folder, 'Transporter')
    queryFolderFolder = os.path.join(transporterFolder, 'Query_Folder')
    
    if not os.path.exists(csvFolder):
        os.mkdir(csvFolder)
    
    if not os.path.exists(transporterFolder):
        os.mkdir(transporterFolder)    
    
    if not os.path.exists(queryFolderFolder):
        os.mkdir(queryFolderFolder)
    
    '''
    Note: 
    It is essential that records that are referenced by other columns using the seqnbr are exported in increasing order. That is the
    only way the sequence numbers generated by the trigger will match the contents of the file.
    '''
    
    instructions       = sorted(acm.FAccountingInstruction.Select('updateTime >"%s"' % (updateTime)), key = lambda instr: instr.JournalValueDefinitions().First().Oid())
    maxSize = len(instructions)
    acctInstrMappings  = acm.FAccountingInstructionMapping.Select('updateTime >"%s"' % (updateTime))
    if acctInstrMappings.Size() > maxSize: 
        maxSize = acctInstrMappings.Size()
    books              = acm.FBook.Select('updateTime >"%s"' % (updateTime))
    if books.Size() > maxSize:
        maxSize = books.Size() 
    bookLinks          = acm.FBookLink.Select('updateTime >"%s"' % (updateTime)).SortByProperty('Oid')
    if bookLinks.Size() > maxSize:
        maxSize = bookLinks.Size() 
    bookMappings       = acm.FBookMapping.Select('updateTime >"%s"' % (updateTime))
    if bookMappings.Size() > maxSize:
        maxSize = bookMappings.Size()
    taccounts          = acm.FTAccount.Select('updateTime >"%s"' % (updateTime))
    if taccounts.Size() > maxSize:
        maxSize = taccounts.Size() 
    taccountallocLinks = acm.FTAccountAllocationLink.Select('updateTime >"%s"' % (updateTime)).SortByProperty('Oid')
    if taccountallocLinks.Size() > maxSize:
        maxSize = taccountallocLinks.Size()
    taccountMappings   = acm.FTAccountMapping.Select('updateTime >"%s"' % (updateTime))
    if taccountMappings.Size() > maxSize:
        maxSize = taccountMappings.Size()
    treatments         = acm.FTreatment.Select('updateTime >"%s"' % (updateTime))
    if treatments.Size() > maxSize:
        maxSize = treatments.Size() 
    treatmentLinks     = acm.FTreatmentLink.Select('updateTime >"%s"' % (updateTime)).SortByProperty('Oid')
    if treatmentLinks.Size() > maxSize:
        maxSize = treatmentLinks.Size()
    treatmentMappings  = acm.FTreatmentMapping.Select('updateTime >"%s"' % (updateTime))
    if treatmentMappings.Size() > maxSize:
        maxSize = treatmentMappings.Size() 
    queryFolders1      = acm.FStoredASQLQuery.Select('name like "A_AC_*" and updateTime >"%s"' % (updateTime))
    if queryFolders1.Size() > maxSize:
        maxSize = queryFolders1.Size()
    queryFolders2      = acm.FStoredASQLQuery.Select('name like "A_AI_*" and updateTime >"%s"' % (updateTime))
    if queryFolders2.Size() > maxSize:
        maxSize = queryFolders2.Size()
    queryFolders3      = acm.FStoredASQLQuery.Select('name like "A_TR_*" and updateTime >"%s"' % (updateTime))
    if queryFolders3.Size() > maxSize:
        maxSize = queryFolders3.Size()
    queryFolders4      = acm.FStoredASQLQuery.Select('name like "A_BO_*" and updateTime >"%s"' % (updateTime))
    if queryFolders4.Size() > maxSize:
        maxSize = queryFolders4.Size()
    
    if (maxSize == 0):
        print ('Nothing to export')
        return
    else:
        print ('Exporting, largest file has %s objects' % maxSize)
    
    ExportCSV(instructions, csvFolder, 'accounting instructions.csv', 'vertical')
    ExportCSV(acctInstrMappings, csvFolder, 'accounting instruction mappings.csv')
    ExportCSV(books, csvFolder, 'books.csv')
    ExportCSV(bookLinks, csvFolder, 'book links.csv')
    ExportCSV(bookMappings, csvFolder, 'book mappings.csv')
    ExportCSV(taccounts, csvFolder, 'taccounts.csv')
    ExportCSV(taccountallocLinks, csvFolder, 'taccount alloc links.csv')
    ExportCSV(taccountMappings, csvFolder, 'taccount mappings.csv')
    ExportCSV(treatments, csvFolder, 'treatments.csv')
    ExportCSV(treatmentLinks, csvFolder, 'treatment links.csv')
    ExportCSV(treatmentMappings, csvFolder, 'treatment mappings.csv')
    
    ExportQueryFolders(queryFolders1, queryFolderFolder)
    ExportQueryFolders(queryFolders2, queryFolderFolder)
    ExportQueryFolders(queryFolders3, queryFolderFolder)
    ExportQueryFolders(queryFolders4, queryFolderFolder)


directorySelection = FRunScriptGUI.DirectorySelection()
time = acm.Time.TimeNow()


ael_variables = [
    ['dest', 'Destination folder', directorySelection, 'C:\\Temp\\', directorySelection, 0, 1, 'Where to export the files', 0, None],
    ['updateTime', 'Export from', 'string', None, time, 0, 1, 'Incremental export from', 0, None],
    ['log_folder', 'Log folder_Logging', 'string', 'C:\\Temp\\', None, 0, 1, 'Select where to store the log file', 0, None],
    ['log_level', 'Log level_Logging', 'string', ['INFO', 'WARN', 'ERROR', 'DEBUG'], None, 1, 0],
    ['logToConsole', 'Log to console_Logging', 'int', [1, 0], 1, 1, 0, 'Whether logging should be done in the Log Console or not.'],
]


def ael_main(params):
    folder = params['dest'].SelectedDirectory().AsString()
    updateTime = params['updateTime']
    ExportAccountingPackage(folder, updateTime)


...

}

